# 系统架构

## 架构总览

Paper Factory 是一个基于 **Skill + Agent 混合架构** 的多智能体学术论文生成系统。系统采用分层编排设计，通过 Skill 层（同步执行）和 Agent 层（独立执行）的协作完成从文献调研到论文撰写的全流程。

```
╔══════════════════════════════════════════════════════════════╗
║               Paper Factory — Skill + Agent 混合架构                      ║
╠═══════════════════════════════════════════════════════╣
║                                                                          ║
║  ┌────────────────────────────────────────────────────────────────────────────┐    ║
║  │  User Request                                              │    ║
║  │      ↓                                                         │    ║
║  │ ┌──────────────────────────────────────────────────┐    │    ║
║  │  │         系统 (主编排器)              │    │    ║
║  │  │                                                 │    │    ║
║  │  │  ══════════════════════════   │    │    ║
║  │  │  │  Skill 层 (同步调用，共享上下文)          │    │    ║
║  │  │  │       ↓ 殇理完整 4-Phase 流程             │    │    ║
║  │  │  │  ├─→ paper-generation (主编排器)        │    │    │    ║
║  │  │  │       ↓                                  │    │    ║
║  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  ↓                                  │    │    ║
║  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │ ║
║  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │ │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │ │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │ │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │ ║
║  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │ ║
║  │                    ↓ (文件系统作为 Agent 间的通信媒介)                        ║
║  ══════════════════════════════════════════════════════   ╣
║                                                                          ║
║  ══════════════════════════════════════════════════════   ╣
║                    ↓ (Skill 同步调用 + 领域分析)              ║
║  ══════════════════════════════════════════════════   ╣
║  ┌─────────────────────────────────────────────────────────────┘     ║
║                                                                          ║
║  │  Phase 1: Research                      │    ║
║  │  ├─ A1 (文献调研) → a1-literature-survey.json/md      │    ║
║  │  ├─ A3-agent (MAS文献) → a3-mas-literature.json/md [条件] │    ║
║  │  └─ A4 (创新聚合) → a4-innovations.json/md        │    ║
║  │                                                                  ║
║  │  Phase 2: Design                        │    ║
║  │  ├─ B1 (相关工作) → b1-related-work.json/md          │    ║
║  │  ├─ B2 (实验设计) → b2-experiment-design.json/md      │    ║
║  │  └─ B3 (架构设计) → b3-paper-outline.json/md          │    ║
║  │                                                                  ║
║  │  Phase 3: Writing                        │    ║
║  │  ├─ C1 (章节撰写) → sections/*.md [多次调用]        │    ║
║  │  ├─ C2 (图表设计) → figures/all-figures.md, tables.md │    ║
║  │  └─ C3 (格式整合) → output/paper.md               │    ║
║  │                                                                  ║
║  │ Phase 4: Quality                       │    ║
║  │  ├─ D1 (同行评审) → d1-review-report.json/md         │    ║
║  │  ├─ D2 (修订执行) → d2-revision-log.json/md [迭代]   │    ║
║  │  ├─ versions/ (版本快照) → V01/, V02/...            │    ║
║  │ └─ user-feedback.json (用户反馈)                │    ║
║  │ └─ user-decision.json (用户决策)            │    ║
║  │                                                                  ║
║  ══════════════════════════════════════════════════════════════╝
║                                                                          ║
```

---

## 核心设计原则

### 1. 分层架构（Layered Architecture）

系统采用 **Skill + Agent 混合架构**，按任务类型分层多

| 层级 | 组件 | 作用 | 通信模式 |
|--------|------|----------|----------|
| **Orchestrator Level** | `paper-generation` — 总编排器，通过 Skill 层实现 |
| **Phase Level** | Phase 编排 Skill — 4 阶段 Skill，串行编排流程 |
| **Domain Research Skills** | 领域分析 Skill — 通过 WebSearch 获取前沿文献 |
| **Agent 层** | 11 个 Agent 组件 — 异步执行，文件系统通信 |
| **Version Manager Skill** | version-manager — 版本管理器，创建快照和管理历史 |

**关键区别**多
- **Skill**多轻量级、同步执行、共享会话上下文
- **Agent**多重量级、异步执行、独立进程

**关键原则**多
- **Skill 在主会话中同步执行**多适合快速分析、知识检索、编排协调
- **Agent 作为独立进程异步执行**多适合长流程、需要专注的写作/评审任务
- **并行执行优化**多Phase 1 支持 A1/A3 的真正并行，通过 Task 工具实现
- **文件系统通信**多Agent 通过读写 workspace 目录传递数据，不依赖对话历史

### 2. 版本管理与用户确认（Versioning & Confirmation）

系统支持完整的版本管理和人类审稿员交互机制。

#### 核心特性

1. **版本快照系统**
   - 每次 Phase 4 迭代后根据配置创建版本快照（V1/V2/V3...）
   - 每个版本包含多论文快照、元数据、评审摘要、变更日志
   - 支持版本比较和回滚
   - 自动清理旧版本（可配置最大保留数量）

2. **里程碑确认机制**
   - 达到目标评分（如 9.0 分）时自动暂停
   - 使用 AskUserQuestion 向人类审稿员展示版本摘要
   - 三种选择多接受定稿 / 提供反馈继续 / 手动编辑

3. **反馈回路**
   - 人类审稿员的修改意见优先级高于评审建议
   - D2 修订专家优先处理用户反馈
   - 反馈状态追踪（pending → addressed）

#### 数据流

```
用户反馈 → user-feedback.json
       ↓
D2 读取 → 用户反馈优先级设为 critical
       ↓
D2 执行修订 → 更新 paper.md
       ↓
D2 更新反馈状态 → addressed
       ↓
下一轮评审 → 验证反馈已解决
```

4. **目录结构扩展**
```
workspace/{project}/
├── versions/              # 版本管理目录
│   ├── meta.json          # 版本索引
│   ├── V01/               # 版本快照
│   │   ├── V02/
│   └── ...
├── phase4/
│   ├── user-feedback.json   # 用户反馈
│   └── user-decision.json   # 用户决策记录
```

---

### 3. 质门控（Quality Gates）

每个阶段完成后验证输出完整性，确保下一阶段有正确的输入多

| Gate | 验证内容 | 失败处理 |
|------|----------|----------|
| Gate 1 | Phase 1 输出文件 | 记录缺失，通知用户 |
| Gate 2 | Phase 2 固定输出 | 验证完整性 |
| Gate 3 | Phase 3 论文完整性 | 6. 质门控最终检查 |
| Gate 4 | 评审报告 + 版本历史 | 质量与可追溯性 |

---

## 4 阶段 Pipeline 详解

### Phase 0: 交互式启动确认

> **设计原则**多在正式进入文献调研之前，通过交互确认确保方向正确。早期确认可以减少 60-70% 的后期返工成本。

**执行模式**多仅在首次生成或 `target_venue` 未指定时执行

**交互节点**多
```
Phase 0: 交互式启动确认
├── 期刊选择与配置加载（interaction-manager + venue-analyzer）
│   ├── phase0_venue_selection ──────────────────┐
│   │   ├── 预定义期刊 → venue-analyzer 自动配置
│   │   └── 自定义期刊 → 提示配置模板
│   │
│   ├── 题目确认（interaction-manager，等待 A4）───────┐
│   │   ├── 候选题目 → 选择/自定义
│   │   └── 确认 → 写入 input-context.md
│   │
│   └── 摘要框架确认（interaction-manager）─────────┘
│       ├── 接受 → 保存默认框架
│       └── 编辑 → 保存用户编辑版本
│
└── 输出文件
    ├── phase0/venue-analysis.json
    ├── phase0/title-options.json
    ├── phase0/abstract-framework.md
    └── venue-style-guide.md（传递给后续 Phase）
```

**新增文件结构**多
```
workspace/{project}/
├── phase0/                   # 启动确认阶段
│   ├── venue-analysis.json
│   ├── title-options.json
│   └── abstract-framework.md
├── venue-style-guide.md      # 期刊写作风格指南
├── user-feedback.json         # 用户反馈结构化存储
├── feedback-history.md        # 反馈历史记录
```

**完成条件**多`input-context.md` 将包含完整的期刊、题目、摘要框架信息

### Phase 1: Research（素材收集）

**执行模式**多并行 Agent + 串行 Skill 混合 + 缓存优化

```
input-context.md (用户提供的项目上下文)
       │
       ↓
系统分析项目特征 → Phase 1 激活条件判断
       │       │
┌───→ A1 (文献调研，必选)
└───→ A3-agent (MAS 文献，涉及 MAS 且需最新文献)
└───→ A4 (创新聚合)
       │
       │
       ↓
并行启动 A1/A3 Agent (Task 工具 run_in_background)
       │       │
       ↓
┌──→ A4 (在 Phase 1 完成后聚合结果)
       │       │
       ↓
domain-knowledge-prep (准备评审专家的领域知识，根据论文内容)
       │
       ↓
缓存优化多通过 cache-utils Skill 的 searchWithCache 减数实现
       │
       ↓
Quality Gate 1 (验证输出完整性)
```

### Phase 2: Design（论文设计）

**执行模式**多严格串行 B1 → B2 → B3

```
b3-paper-outline.json (Phase 1 的 A4 输出)
       │
       ↓
B1 (相关工作分析)
       │       ↓
B2 (实验设计)
       │       ↓
B3 (论文架构设计)
       │       ↓
Quality Gate 2
```

### Phase 3: Writing（论文撰写）

**执行模式**多串行 C1 (按章节）→ C2 → C3

```
b3-paper-outline.json (Phase 2 的 B3 输出)
       │
       ↓
C1 逐章节撰写
       │       ↓
C2 (设计图表)
       │       ↓
C3 (格式整合 → output/paper.md
       │       ↓
Quality Gate 3
```

### Phase 4: Quality（质量保障）

**执行模式**多迭代循环 D1 ⇄ D2 + 版本管理 + 用户确认

```
d1-review-report.json (评审报告)
       │
       ↓
d2-revision-log.json (修订日志)
       │
       ↓
[版本创建循环] (versioning 配置控制)
       │       │  ├─ 创建版本快照 → versions/V{NN}/
       │       │ ├─ 达到阈值？ → 用户确认 (confirmation 配置)
       │       │ └─ 接受 → 定稿 / 反馈继续 / 手动编辑
       │       │ └─ ↓
       ↓
[用户反馈回路] (feedback 配置控制)
       │       │ ├─ 用户提出修改 → user-feedback.json
       │       │ └─ D2 优先处理 → 下一轮迭代
       │       │ └─ ↓
       ↓
Quality Gate 4 (最终门控 + 版本历史验证)
```

---

## 5. 辅助工具与技能

### Skills 层（25+ 个专业技能）

| 类别 | Skill | 功能说明 |
|------|------|----------|
| **主编排器** |
| `paper-generation` | 论文生成主编排器，管理完整 4 阶段流程 |
| **Phase 编排** |
| `paper-phase1-research` | Phase 1 编排器，支持并行执行优化 |
| `paper-phase2-design` | Phase 2 编排器，相关工作分析、实验设计、架构 |
| `paper-phase3-writing` | Phase 3 编排器，章节撰写、图表设计、格式整合 |
| `paper-phase4-quality` | Phase 4 编排器，多视角评审、版本管理、用户确认 |
| **缓存优化** |
| `paper-phase1-parallel` | Phase 1 并行执行增强 |
| **版本管理** |
| `domain-knowledge-prep` | 领域知识准备 |
| `domain-knowledge-update` | 领域知识更新 |
| **论文缓存** |
| `paper-cacher` | 论文缓存管理 |
| `cache-utils` | 论文缓存工具集 |
| **版本管理器** | **新增** |

### Domain Research Skills（4 个）

| Skill | 用途 |
|-------|------|
| `research-mas-theory` | MAS 理论分析 |
| `research-kg-theory` | KG/本体理论分析 |
| `research-nlp-sql` | NL2SQL 理域分析 |
| `research-bridge-eng` | 桥梁工程理沦分析 |

### 辅助工具（可选）

| MCP 工具集 | Chrome DevTools Protocol |
| --- | --- | --- |

---

## 6. 配置文件详解

config.json 是系统的核心配置文件，控制模型选择、质量阈值、并行执行、缓存策略、版本管理、用户确认等所有关键行为。

### 配置节结构

```json
{
  // 模型配置
  "models": {
    "reasoning": "opus",
    "writing": "sonnet"
  },

  // 质量门控配置
  "quality": {
    "min_papers": 40,
    "min_review_score": 9.0,
    "max_review_iterations": 15,
    "max_response_rounds": 3,
    "dynamic_scoring": true
  },

  // 并行执行配置
  "parallel": {
    "phase1_enabled": true,
    "use_task_tool": true,
    "timeout_per_agent": 300,
    "retry_on_failure": true,
    "max_retries": 1
  },

  // 论文缓存系统
  "cache": {
    "enabled": true,
    "max_papers_per_domain": 500,
    "purge_after_days": 365,
    "auto_generate_index": true
  },

  // 版本管理配置
  "versioning": {
    "enabled": true,
    "mode": "milestones",           // all | milestones | smart | off
    "max_versions_to_keep": 10
  },

  // 用户确认配置
  "confirmation": {
    "mode": "threshold",         // full | skip | threshold
    "threshold_score": 9.0,
    "confirm_at_milestones": true,
    "confirm_every_n_iterations": null,
    "require_approval_for_final": true
  },

  // 反馈回路配置
  "feedback": {
    "enabled": true,
    "priority_over_reviewer": true,  // 用户反馈优先级高于评审者
    "track_status": true
  },

  // 领域映射
  "domain_skills": { ... },
  "skills": { ... }
}
```

---

## 7. 11 个 Agent 组件

| Phase | Agent | 文件 | 角色 | 模型 | 激活条件 |
|------|---------|--------|------|---------|
| Research | A1 | `agents/phase1/a1-literature-surveyor.md` | 文献调研 | Sonnet | $3 | 必选 |
| Research | A3 | `agents/phase1/a3-mas-theorist.md` | MAS 文献调研 | Opus | $4 | 条件多涉及 MAS 且需最新文献 |
| Research | A4 | `agents/phase1/a4-innovation-formalizer.md` | 创新形式化（聚合） | Opus | $3 | 必选 |
| Design | B1 | `agents/phase2/b1-related-work-analyst.md` | 相关工作分析 | Opus | $3 | 必选 |
| Design | B2 | `agents/phase2/b2-experiment-designer.md` | 实验设计 | Opus | $3 | 必选 |
| Design | B3 | `agents/phase2/b3-paper-architect.md` | 论文架构设计 | Opus | $4 | 必选 |
| Writing | C1 | `agents/phase3/c1-section-writer.md` | 章节撰写 | Sonnet | $2 | 必选 |
| Writing | C2 | `agents/phase3/c2-visualization-designer.md` | 可视化设计 | Sonnet | $3 | 必选 |
| Writing | C3 | `agents/phase3/c3-academic-formatter.md` | 学术格式化 | Sonnet | $3 | 必选 |
| Quality | D1 | `agents/phase4/d1-peer-reviewer.md` | 同行评审 | Opus | $5 | 必选 |
| Quality | D2 | `agents/phase4/d2-revision-specialist.md` | 修订执行 | Opus | $4 | 条件多评审分数低于阈值 |

**关键特性**多
- **异步执行**多所有 Agent 作为独立进程通过文件系统通信，不依赖对话历史
- **专用 Prompt**多每个 Agent 有精心设计的系统提示，专注于其任务
- **可复用性**多Agent Prompt 通用模板，可跨项目使用
- **工具权限**多根据任务需求分配 WebSearch、Read、Write、Bash 等

---

## 8. 数据流详解

### Skill 层通信（主会话 → Phase Skills）

```
系统(CLAUDE.md) 主会话 → Skill(paper-phase1-research)
    ↓
Skill(paper-phase1-research) → Domain Research Skills (按需调用)
    ↓
Skill(paper-phase2-design) → ...
    ↓
Skill(paper-phase3-writing) → ...
    ↓
Skill(paper-phase4-quality) → ...
```

### Agent 层通信（主会话 → Agent）

```
系统(CLAUDE.md) 主会话 → Agent(A1/A3/A4)
    ↓
Agent(A1) → a1-output.json/md
    ↓
Agent(A3-agent) → a3-output.json/md [条件]
    ↓
Agent(A4) → a4-output.json/md
    ↓
Quality Gate 1 → 合并 A4 输出
    ↓
Phase 2 开始
```

### 版本管理数据流

```
Phase 4 迭代完成
    ↓
检查 versioning 配置
    ↓
根据模式判断是否创建版本
    ├─ 是 → Skill(version-manager) 创建版本快照
    │     ├─ 否 → 继续
    ↓
版本快照创建完成
    ↓
检查 confirmation 配置
    ├─ 达到阈值？ → 是 → Skill 内部调用 AskUserQuestion
    │  │     └─ 否 → 继续
    ↓
用户决策
    ├─ 接受 → 定稿完成
    │ │     ├─ 反馈继续 → 记录到 user-feedback.json
    │  │     └─ 手动编辑 → 暂停等待
    ↓
Quality Gate 4
```

---

## 9. 错误处理与恢复

### Agent 失败重试
- Quality Gate 失败记录错误
- 文件系统通信失败通知用户

### 版本清理
- 保留版本数超限时自动清理
- 愾本回滚到上一个稳定版本

### 用户中断恢复
- 支持手动编辑后恢复流程
- 版本比较确认当前状态正确性

---

## 10. 系统扩展性

### 新增 Skill 扩展流程

1. 在 `.claude/skills/` 创建新 Skill 目录
2. 编写 SKILL.md 定义功能和调用方式
3. 在 SKILL.md 使用 YAML Frontmatter 定义元数据
4. 更新 skills-catalog.md 注册新 Skill
5. 在 config.json 的 skills 节点添加配置

### 新增 Agent 扩展流程

1. 在 `agents/{phase}/` 创建新 Agent .md 文件
2. 编写专用 Prompt，包含角色定义、职责边界
3. 更新 agents-catalog.md 注册 Agent

### 新增领域

1. 创建 review-{domain}-domain Skill
2. 更新 domain_skills 映射

---

## 11. 总结

**核心理念**多Skill-Agent 混合架构通过分层职责协作，实现端到端的学术论文自动生成。

**关键特性**多
- **并行执行优化**多Phase 1 真正并行，提升效率 40-60%
- **质量保障**多4 阶段迭代评审，确保学术质量
- **版本管理**多完整历史追溯，可回滚
- **人类交互**多里程碑确认，反馈回路，人机协作
- **通用框架**多不绑定特定主题，适配任意研究领域
- **缓存优化**多第二次生成提速 60-80%

---

**设计演进**多从纯 Agent 架构 → Skill-Agent 混合架构 → 版本管理 + 用户确认 + 交互式生成
